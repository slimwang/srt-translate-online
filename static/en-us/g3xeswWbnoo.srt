1
00:00:00,460 --> 00:00:02,890
We're going to start by setting
up an AuthStateListener.

2
00:00:02,890 --> 00:00:03,710
Why?

3
00:00:03,710 --> 00:00:07,979
Well, our app has two states,
signed in and signed out.

4
00:00:07,980 --> 00:00:11,490
And we need a way to determine which
of these states the app is in.

5
00:00:11,490 --> 00:00:16,149
An AuthStateListener is a listener which
we attach to the fire base off object.

6
00:00:16,149 --> 00:00:19,320
It executes whenever
the authentication state changes.

7
00:00:19,320 --> 00:00:21,570
This includes when the listener
is first attached and

8
00:00:21,570 --> 00:00:23,550
FirebaseAuth is first initialized.

9
00:00:23,550 --> 00:00:26,400
In that way as soon as the user opens
the app you can know what state

10
00:00:26,399 --> 00:00:27,299
they're in.

11
00:00:27,300 --> 00:00:28,839
Our listener will have the code for

12
00:00:28,839 --> 00:00:33,250
both setting up after you sign in and
tearing the UI down after they sign out.

13
00:00:34,490 --> 00:00:38,173
So the code in the AuthStateListener
will determine what to show the user.

14
00:00:38,173 --> 00:00:39,679
Following best practices,

15
00:00:39,679 --> 00:00:43,573
we'll test the listener in onResume
when the app is started and visible.

16
00:00:43,573 --> 00:00:46,908
And we'll also clean up the listener by
detaching in onPause when the app is no

17
00:00:46,908 --> 00:00:48,500
longer visible.

18
00:00:48,500 --> 00:00:51,969
It's important to remember to attach and
detach the listener,

19
00:00:51,969 --> 00:00:55,560
especially since because now we're
showing multiple activities in the app.

20
00:00:55,560 --> 00:00:58,880
The first is the activity when you're
signed in, which is our main activity.

21
00:00:58,880 --> 00:01:02,789
And the other activity is the login
flow that show when you're signed out.

22
00:01:02,789 --> 00:01:06,813
Note that the activities with the log
in flow are generated by AuthUI.

23
00:01:06,813 --> 00:01:09,820
You want to make sure to be careful not
to attach the same listener more than

24
00:01:09,819 --> 00:01:13,019
once as you navigate back and
forth between the two states.

25
00:01:13,019 --> 00:01:16,179
But for now, we'll just worry about
setting up the AuthStateListener and

26
00:01:16,180 --> 00:01:19,450
having it launch our sign in screen
if the user's not logged in.

27
00:01:19,450 --> 00:01:22,200
If the user is logged in, for
now, we'll just show a toast.

28
00:01:22,200 --> 00:01:24,359
Okay, enough talk, time to create.

29
00:01:24,359 --> 00:01:27,349
I'm here in MainActivity, and
as with any fire based service,

30
00:01:27,349 --> 00:01:30,839
the first thing you're going to need to
do is get an instance of the class, and

31
00:01:30,840 --> 00:01:33,180
in this case the class
is called FireBaseAuth.

32
00:01:33,180 --> 00:01:35,840
I'll make an instance variable for
it right here.

33
00:01:35,840 --> 00:01:39,170
I will also need a variable for
my Authentication State Listener.

34
00:01:40,299 --> 00:01:42,429
So I'll make that right here.

35
00:01:42,430 --> 00:01:44,840
Okay and
now let's initialize FireBaseAuth.

36
00:01:44,840 --> 00:01:47,070
So I'm going to scroll down to onCreate,
and

37
00:01:47,069 --> 00:01:51,429
right after I initialize the database
I will initialize my Auth object.

38
00:01:51,430 --> 00:01:56,340
And I do it in a similar way to how I
initialized my FirebaseDatabase object.

39
00:01:56,340 --> 00:01:58,695
I call the static method
getInstance on FirebaseAuth.

40
00:01:59,909 --> 00:02:03,039
And I also need to initialize my
authentication state listener and

41
00:02:03,040 --> 00:02:05,820
I'm going to do that at the bottom
of onCreate so let me scroll down.

42
00:02:07,090 --> 00:02:11,913
And here at the bottom I'm going
to say mAuthStateListener =

43
00:02:11,913 --> 00:02:14,890
new AuthenticationStateListener.

44
00:02:16,250 --> 00:02:19,219
Right now you've created your
AuthenticationStateListener, but

45
00:02:19,219 --> 00:02:21,009
you haven't attached it yet.

46
00:02:21,009 --> 00:02:24,179
If you remember what I said before
you're going to do that in on resume.

47
00:02:25,349 --> 00:02:29,649
So let's scroll down and we're going to
add both onResume and onPause.

48
00:02:30,819 --> 00:02:35,879
So here in onResume I'm going to add
the AuthenticationStateListener.

49
00:02:35,879 --> 00:02:39,329
And I'll do that by calling
on my FirebaseAuth object.

50
00:02:39,330 --> 00:02:43,120
Add AuthenticationStateListener and
I'll pass in the listener.

51
00:02:43,120 --> 00:02:47,259
And then up here onPause I'm going to
do the corresponding removal of

52
00:02:47,259 --> 00:02:47,739
the listener.

53
00:02:49,400 --> 00:02:52,900
And that's just using
the removeAuthStateListener method.

54
00:02:52,900 --> 00:02:56,680
Okay, so I'm adding it and
I'm removing it as the activity is

55
00:02:56,680 --> 00:02:58,740
in the foreground and
then no longer in the foreground.

56
00:02:59,740 --> 00:03:00,950
So at this point, we have a listener.

57
00:03:00,949 --> 00:03:03,250
It's getting added and it's good to go.

58
00:03:03,250 --> 00:03:06,500
But if we scroll up to our
actual definition of it,

59
00:03:06,500 --> 00:03:08,879
it is not actually doing anything.

60
00:03:08,879 --> 00:03:12,090
So, what you want to do, is to actually
check to see if the user is logged in or

61
00:03:12,090 --> 00:03:13,060
not.

62
00:03:13,060 --> 00:03:14,298
And then if they're not logged in,

63
00:03:14,298 --> 00:03:15,840
you're going to show
them that log in screen.

64
00:03:16,849 --> 00:03:20,846
Now, in this on off changed method,
you're given this parameter here,

65
00:03:20,847 --> 00:03:22,596
this FirebaseAuth parameter.

66
00:03:22,596 --> 00:03:25,927
And the difference between this
FirebaseAuth parameter and

67
00:03:25,927 --> 00:03:30,235
the one that you initialized up here, is
that this one is guaranteed to contain

68
00:03:30,235 --> 00:03:33,518
whether at that moment,
the user is authenticated or not.

69
00:03:33,519 --> 00:03:37,659
And this variable has two states, it's
either signed in or it's signed out.

70
00:03:37,659 --> 00:03:41,562
Okay, so I'm going to use this variable
to get something called a FirebaseUser,

71
00:03:41,562 --> 00:03:45,500
and then I can check if
the user's actually logged in,

72
00:03:45,500 --> 00:03:49,289
by seeing if this Firebase
user is null or not.

73
00:03:49,289 --> 00:03:51,269
So here are our two cases.

74
00:03:51,270 --> 00:03:54,390
The user is signed in if
the user is not null, or

75
00:03:54,389 --> 00:03:56,569
they're signed out if they are null.

76
00:03:56,569 --> 00:03:57,009
And here,

77
00:03:57,009 --> 00:04:01,039
where the user is signed out, is where
you want to launch the sign in flow.

78
00:04:01,039 --> 00:04:03,889
And that's where FirebaseUI comes in.

79
00:04:03,889 --> 00:04:05,639
FirebaseUI is spectacular,

80
00:04:05,639 --> 00:04:09,909
because with just one call, it'll
start this whole sign in flow for us.

81
00:04:09,909 --> 00:04:14,530
Over in FireBaseUI's auth read me,
they have a couple of sign in examples.

82
00:04:14,530 --> 00:04:17,398
And this one here is actually
the closest to what we want.

83
00:04:17,398 --> 00:04:20,500
It enables sign in with some providers.

84
00:04:20,500 --> 00:04:24,699
So, I'm going to go ahead and
copy this, and then over here,

85
00:04:24,699 --> 00:04:27,269
if the user is signed out,
I'm going to go ahead and

86
00:04:27,269 --> 00:04:32,870
call that method to start the sign
in flow, with a few small changes.

87
00:04:32,870 --> 00:04:34,600
I'm going to get rid of
this Facebook Provider,

88
00:04:34,600 --> 00:04:36,080
because we're not using Facebook.

89
00:04:36,079 --> 00:04:38,620
Authentication for a.

90
00:04:38,620 --> 00:04:43,102
And here I'm going to do something
called disabling SmartLock by setting is

91
00:04:43,101 --> 00:04:45,544
SmartLockEnabled to false.

92
00:04:45,545 --> 00:04:49,069
SmartLock allows the phone to sort
of automatically save the user's

93
00:04:49,069 --> 00:04:51,139
credentials and try to log them in.

94
00:04:51,139 --> 00:04:54,149
But for our simple learning purposes,
we're not going to be using it.

95
00:04:55,230 --> 00:04:58,970
You might also notice that you're
passing in this RC_SIGN_IN constant.

96
00:04:58,970 --> 00:05:02,760
If I scroll up, I'll see that
I'm doing this static import and

97
00:05:02,759 --> 00:05:04,899
I actually don't want to do that.

98
00:05:04,899 --> 00:05:07,799
Android Studio just kind of
automatically added it for me.

99
00:05:07,800 --> 00:05:11,050
I want to define this constant myself.

100
00:05:12,509 --> 00:05:17,399
So up here I'm going to add
a public static final integer and

101
00:05:17,399 --> 00:05:22,489
I'm going to call it RC_SIGN_IN,
and we'll set it = 1.

102
00:05:22,490 --> 00:05:27,170
The RC here stands for request code, and
if we scroll back down to where we use

103
00:05:27,170 --> 00:05:33,009
it, so RC_SIGN_IN is passed in down
here to startActivityForResult.

104
00:05:33,009 --> 00:05:37,509
And it's a flag for when we return from
starting the activity for the result.

105
00:05:38,649 --> 00:05:42,329
And I promise we'll be using this
shortly so hold tight on this one.

106
00:05:42,329 --> 00:05:45,370
Finally, when these are signed in, I'm
just going to add a quick little toast.

107
00:05:46,879 --> 00:05:48,110
Okay and here's the Toast.

108
00:05:50,300 --> 00:05:53,250
We want to be able to know when
the user actually successfully signs in

109
00:05:53,250 --> 00:05:56,730
with the log in flow which
is why I'm adding this.

110
00:05:56,730 --> 00:05:58,410
Okay so let's try running the code now.

111
00:05:59,579 --> 00:06:02,599
So you'll see that instead of going
straight to the chat messages,

112
00:06:02,600 --> 00:06:04,948
you now see this sign in flow.

113
00:06:04,947 --> 00:06:09,079
This sign in flow was brought to you
by Firebase UI, which is pretty nifty

114
00:06:09,079 --> 00:06:12,680
considering that you only had to
write this one line of code here.

115
00:06:12,680 --> 00:06:15,670
Okay, so I'm going to say,
sign in with email.

116
00:06:15,670 --> 00:06:19,640
And Firebase UI actually deals with
the entire login flow for that.

117
00:06:19,639 --> 00:06:21,729
So I'll enter my email here.

118
00:06:21,730 --> 00:06:24,590
And then it's smart enough to know
that I don't have an account yet.

119
00:06:24,589 --> 00:06:27,149
So I could give it my name and
a password.

120
00:06:28,149 --> 00:06:29,889
Okay, and then I'll save it.

121
00:06:29,889 --> 00:06:32,810
Now that I'm successfully
logged in I see my toast.

122
00:06:32,810 --> 00:06:36,280
There are a couple bugs on this screen
though and they mostly have to do with

123
00:06:36,279 --> 00:06:39,619
our read listener and permissions and
you'll be fixing that up next.

124
00:06:39,620 --> 00:06:42,689
But for now, revel in the fact that
you've logged in your first user.

125
00:06:43,720 --> 00:06:48,370
Also, if you go to your off tab,
you'll be able to see them created here.

126
00:06:48,370 --> 00:06:48,910
Awesome work.

